/*
универсальный мартин. Вводим коридор, пунктов профита при закрытии всей серии, количество переворотов, коэфицент умножения.
В советнике надо позоботиться чтобы хватало средств для выдерживания залога. В советнике это не проедумотрено. Иначе ордера при не хватке средств
не будут открываться
*/
#property copyright "Ves Volk"
#property link      ""


extern double Лот = 0.01;
extern int Коридор = 200;
extern int ПунктПрофит = 30;
extern int Профит1ордера = 200;
extern int ФиксСтоп = -50;
extern int КоэфУмн = 8;
extern int КолПереворотов = 2;
extern bool ВремяРаботы = false;
extern int НачалоРаботыЧас = 6;
extern int КонецРаботыЧас = 19;


int Тикет1гоОрдера, КонтрОшибок, РеальныеПеревороты;
double ЦенаУстановкиОтлОрдера;
datetime КонтрольВремени;

int start()
  {
   //проверяем наличие ордеров--------------------------------------------------------
      //есть ордера
   if (OrdersTotal () > 0)
   {
      //если рыночный ордер один
      if (OrdersTotal() == 1)
         //проверяем закрылся ли рервый ордер по профиту, если да то закрываем все ордера
         if (OrderSelect(Тикет1гоОрдера, SELECT_BY_TICKET) == true)
            if (OrderCloseTime() > 0)
               ЗакрытьОрдера();
      //вычисляем сколько переворотов случилось
      РеальныеПеревороты = OrdersTotal() - 1;
      //проверяем можно ли еще переворачивать-----------------------------------------
         //можно переворачивать
      if (РеальныеПеревороты < КолПереворотов)
      {
         //вычисляем тикет позднего ордера
         КонтрольВремени = 0;
         int a = 0;
         for (int i = OrdersTotal(); i != -1; i--)
            if (OrderSelect (i, SELECT_BY_POS) == true)
            {
               if (a == 0)
               {
                  a = 1;
                  КонтрольВремени = TimeLocal() - OrderOpenTime();
                  КонтрОшибок = OrderTicket();
                  continue;
               }
               
               if (TimeLocal() - OrderOpenTime() < КонтрольВремени)
               {
                  КонтрольВремени = TimeLocal() - OrderOpenTime();
                  КонтрОшибок = OrderTicket();
               }
            }
            
         //вычисляем тип позднего ордера---------------------------------------------------
         if (OrderSelect (КонтрОшибок, SELECT_BY_TICKET) == true)
            //ордер рыночный
            if (OrderType() < 2)
            {
               //убираем профит с первого оредра
               if (OrdersTotal() == 2)
                  OrderModify (Тикет1гоОрдера, 0, 0, 0, 0);
               //выставляем отложенный ордер---------------------------------------------------
               if (OrderType() == OP_SELL)
               {
                  КонтрОшибок = OrderSend (Symbol(), OP_BUYSTOP, OrderLots() * КоэфУмн, NormalizeDouble (OrderOpenPrice() + Коридор * Point, Digits), 2, 0, 0);
                  if (КонтрОшибок == -1)
                  {
                     Print ("Ордер вернул ошибку ", GetLastError());
                     return;
                  }
               }
               else
               {
                  КонтрОшибок = OrderSend (Symbol(), OP_SELLSTOP, OrderLots() * КоэфУмн, NormalizeDouble (OrderOpenPrice() - Коридор * Point, Digits), 2, 0, 0);
                  if (КонтрОшибок == -1)
                  {
                     Print ("Ордер вернул ошибку ", GetLastError());
                     return;
                  }
               }
            }
            //отложенный ордер
            else
            {
               //если рыночный ордер один то он должен закрыться по тейку
               if (OrdersTotal() == 2)
                  return;
               //вычисляем тикет последнего рыночного ордера
               КонтрольВремени = 0;
               int b = 0;
               for (int i2 = OrdersTotal(); i2 != -1; i2--)
                  if (OrderSelect (i2, SELECT_BY_POS) == true)
                  {
                     if (OrderType() > 1)
                        continue;
                     if (b == 0)
                     {
                        b = 1;
                        КонтрольВремени = TimeLocal() - OrderOpenTime();
                        КонтрОшибок = OrderTicket();
                        continue;
                     }
               
                     if (TimeLocal() - OrderOpenTime() < КонтрольВремени)
                     {
                        КонтрольВремени = TimeLocal() - OrderOpenTime();
                        КонтрОшибок = OrderTicket();
                     }
                  }
               //проверяем профит последнего рыночного ордера------------------------------------------------------
               if (OrderSelect (КонтрОшибок, SELECT_BY_TICKET) == true)
                  //если сел ордер
                  if (OrderType() == OP_SELL)
                  {
                     //если профит отрицательный то выходим
                     if (OrderOpenPrice() - Ask <= 0)
                        return;
                     //если профит положительный   
                     else
                        if (OrderOpenPrice() - Ask >= ПунктПрофит * Point)
                           ЗакрытьОрдера();
                  }
                  //если бай ордер      
                  else
                  {
                     //если профит отрицательный то выходим
                     if (Bid - OrderOpenPrice() <= 0)
                        return;
                     //если профит положительный   
                     else
                        if (Bid - OrderOpenPrice() >= ПунктПрофит * Point)
                           ЗакрытьОрдера();
                   }
            }
      }
         //нельзя переворачивать-------------------------------------------------------------------------------------
      else
      {
         //вычисляем тикет позднего ордера
         КонтрольВремени = 0;
         int c = 0;
         for (int i3 = OrdersTotal(); i3 != -1; i3--)
            if (OrderSelect (i3, SELECT_BY_POS) == true)
            {
               if (c == 0)
               {
                  c = 1;
                  КонтрольВремени = TimeLocal() - OrderOpenTime();
                  КонтрОшибок = OrderTicket();
                  continue;
               }
               
               if (TimeLocal() - OrderOpenTime() < КонтрольВремени)
               {
                  КонтрольВремени = TimeLocal() - OrderOpenTime();
                  КонтрОшибок = OrderTicket();
               }
            }
         
         //проверяем тип последнего оредра----------------------------------------------------------------------
         if (OrderSelect (КонтрОшибок, SELECT_BY_TICKET) == true)
            //поздний ордер является рыночным
            if (OrderType() < 2)
               //сел
               if (OrderType() == OP_SELL)
               {
                  //если профит отрицательный
                     if (OrderOpenPrice() - Ask <= ФиксСтоп * Point)
                        ЗакрытьОрдера();
                     //если профит положительный   
                     else
                        if (OrderOpenPrice() - Ask >= ПунктПрофит * Point)
                           ЗакрытьОрдера();
               }
               //бай
               else
               {
                  //если профит отрицательный
                     if (Bid - OrderOpenPrice() <= ФиксСтоп * Point)
                        ЗакрытьОрдера();
                     //если профит положительный   
                     else
                        if (Bid - OrderOpenPrice() >= ПунктПрофит * Point)
                           ЗакрытьОрдера();
                }
            //поздний ордер является отложенным
            else
            {
               //вычисляем тикет последнего рыночного ордера
               КонтрольВремени = 0;
               int bb = 0;
               for (int i4 = OrdersTotal(); i4 != -1; i4--)
                  if (OrderSelect (i4, SELECT_BY_POS) == true)
                  {
                     if (OrderType() > 1)
                        continue;
                     if (bb == 0)
                     {
                        bb = 1;
                        КонтрольВремени = TimeLocal() - OrderOpenTime();
                        КонтрОшибок = OrderTicket();
                        continue;
                     }
               
                     if (TimeLocal() - OrderOpenTime() < КонтрольВремени)
                     {
                        КонтрольВремени = TimeLocal() - OrderOpenTime();
                        КонтрОшибок = OrderTicket();
                     }
                  }
                  
               //проверяем последний рыночный ордер на профит---------------------------------------------------------------
               if (OrderSelect (КонтрОшибок, SELECT_BY_TICKET) == true)
                  //если сел ордер
                  if (OrderType() == OP_SELL)
                  {
                     //если профит отрицательный то выходим
                     if (OrderOpenPrice() - Ask <= 0)
                        return;
                     //если профит положительный   
                     else
                        if (OrderOpenPrice() - Ask >= ПунктПрофит * Point)
                           ЗакрытьОрдера();
                  }
                  //если бай ордер      
                  else
                  {
                     //если профит отрицательный то выходим
                     if (Bid - OrderOpenPrice() <= 0)
                        return;
                     //если профит положительный   
                     else
                        if (Bid - OrderOpenPrice() >= ПунктПрофит * Point)
                           ЗакрытьОрдера();
                   }
            }
         
      }
   }
      //нет ордеров-------------------------------------------------------------------------------------------------------
   else
   {
      //проверяем включен ли контроль времени
      if (ВремяРаботы)
      {
         //если время не рабочее, то выходим
         if (Hour() < НачалоРаботыЧас || Hour() > КонецРаботыЧас)
            return;
      }
      //выставляем ордеров
      Тикет1гоОрдера = OrderSend (Symbol(), OP_BUY, Лот, NormalizeDouble(Ask, Digits), 2, 0, 0);
      if (Тикет1гоОрдера == -1)
      {
         Print ("Ордер вернул ошибку ", GetLastError());
         return;
      }
      
      if (OrderSelect (Тикет1гоОрдера, SELECT_BY_TICKET) == true)
         ЦенаУстановкиОтлОрдера = OrderOpenPrice();
      
      OrderModify (Тикет1гоОрдера, 0, 0, NormalizeDouble (ЦенаУстановкиОтлОрдера + Профит1ордера * Point, Digits), 0);
      
      КонтрОшибок = OrderSend (Symbol(), OP_SELLSTOP, Лот * КоэфУмн, NormalizeDouble(ЦенаУстановкиОтлОрдера - Коридор * Point, Digits), 2, 0, 0);
      if (КонтрОшибок == -1)
      {
         Print ("Ордер вернул ошибку ", GetLastError());
         OrderClose (Тикет1гоОрдера, Лот, NormalizeDouble(Bid, Digits), 2);
         return;
      }
   }    
   
   return(0);
  }




//---------------------функция закрытия всех ордеров------------------------------------------------------------------------
void ЗакрытьОрдера ()
{
   for (int del = OrdersTotal(); del != -1; del --)
      if (OrderSelect (del, SELECT_BY_POS) == true)
         if (OrderType() == OP_BUY)
            OrderClose(OrderTicket(), OrderLots(), NormalizeDouble(Bid, Digits), 2);
         else
            if (OrderType() == OP_SELL)
               OrderClose(OrderTicket(), OrderLots(), NormalizeDouble(Ask, Digits), 2);
            else
               OrderDelete(OrderTicket());
}